# App Store: бесплатный первый месяц/год по промо-коду и пробный период

Документ описывает, как работают предложения «бесплатный первый месяц» и «бесплатный первый год» в App Store, нужны ли доработки в приложении, и различие между Offer Codes и Introductory Offers.

---

## Краткий итог

| Тип предложения | Применяется | Нужны изменения в приложении |
|-----------------|-------------|------------------------------|
| **Introductory Offer** (вводное предложение) | Автоматически при покупке | Нет |
| **Offer Code** (промо-код) | При вводе кода | Нет — если пользователь вводит код в Настройках/App Store. Да — если нужна кнопка ввода кода внутри приложения |

---

## 1. Типы предложений в App Store Connect

### 1.1. Introductory Offer (вводное предложение)

- Настраивается в **Subscription Offers** → **Introductory Offers**
- Типы: Free (бесплатный пробный период), Pay as you go, Pay up front
- **Применяется автоматически**: когда подходящий пользователь нажимает «Подписаться», App Store показывает предложение (например, «1 месяц бесплатно, далее 4.99$/мес»)
- Обычно действует только для новых подписчиков (eligibility проверяет Apple)

**Доработки в приложении:** не требуются. Логика покупки (`Purchases.purchasePackage`) остаётся прежней.

### 1.2. Offer Code (промо-код)

- Настраивается в **Subscription Offers** → **Offer Codes**
- Примеры: "One month free", "one year free"
- Пользователь получает скидку/бесплатный период только после ввода промо-кода
- Не применяется автоматически при обычной покупке

---

## 2. Текущая конфигурация Summify

По данным App Store Connect и `StoreKitConfig.storekit`:

| Продукт | Offer Code | Introductory Offer |
|---------|------------|-------------------|
| SummifyPremiumMonth (1m_sb_nbn_pr) | "One month free" — первый месяц бесплатно | Нет |
| SummifyPremiumYear (1y_sb_nbn_pr) | "one year free" — первый год бесплатно | Нет |

То есть сейчас настроены **Offer Codes**, а не автоматические Introductory Offers.

---

## 3. Работают ли Offer Codes без доработок?

### Да, если пользователь вводит код вне приложения

Пользователь может погасить код в системе iOS:
- **Настройки** → [Имя пользователя] → **Медиа и покупки** → **Погасить подарочную карту или код**
- Или в приложении App Store в профиле

После погашения подписка активируется, RevenueCat видит `CustomerInfo` с активным entitlement, приложение считает пользователя подписчиком. Дополнительный код в Summify не нужен.

### Нужны доработки, если ввод кода внутри приложения

Если нужна кнопка «Есть промо-код?» или «Ввести код» на экране подписок:
1. Добавить кнопку на экран подписок (например, `SubscriptionScreenLimit`)
2. По нажатию вызывать системный UI Apple для погашения кода

Это требует platform channel к нативному iOS (`SKStorefront.presentCodeRedemptionSheet` в StoreKit 2), так как `purchases_flutter` не предоставляет этот API напрямую.

---

## 4. Сравнение сценариев

```mermaid
flowchart TD
    subgraph OfferCode [Offer Code]
        A1[Пользователь вводит код в Настройках/App Store] --> B1[Подписка активируется]
        B1 --> C1[RevenueCat видит entitlement]
        C1 --> D1[Приложение открывает премиум]
    end
    
    subgraph InApp [Ввод кода в приложении]
        A2[Кнопка "Есть промо-код?"] --> A3[Platform channel к StoreKit]
        A3 --> A4[presentCodeRedemptionSheet]
        A4 --> B2[Системный диалог ввода кода]
        B2 --> C2[Подписка активируется]
        C2 --> D2[Приложение открывает премиум]
    end
```

---

## 5. Рекомендации

1. **Offer Codes уже работают** — при ручном погашении в Настройках или App Store. Менять код не обязательно.
2. **Для удобства** можно добавить кнопку ввода кода внутри приложения — потребуется platform channel к StoreKit.
3. **Для автоматического пробного периода** (без кода) нужно создать **Introductory Offer** в App Store Connect — тогда первый месяц/год будет предлагаться автоматически при покупке.

---

## 6. Связанные файлы

- [subscriptions_and_limits.md](./subscriptions_and_limits.md) — инфраструктура подписок и лимитов
- `lib/bloc/subscriptions/subscriptions_bloc.dart` — логика покупки и проверки статуса
- `lib/helpers/purchases.dart` — инициализация RevenueCat
- `lib/screens/subscribtions_screen/subscriptions_screen_limit.dart` — экран подписок

---

*Документ создан на основе исследования 07.02.2025*
