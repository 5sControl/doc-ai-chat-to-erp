# Kokoro TTS Integration - Checklist для тестирования

## Версия библиотеки

- **kokoro_tts_flutter**: `0.2.0+1` (stable)
- **Причина использования стабильной версии**: Experimental версия 0.2.1-exp имеет проблемы с пустым lexicon и вызывает FormatException при фонетизации
- **Основные возможности**:
  - Поддержка int8 моделей для улучшения производительности
  - Стандартизированный формат аудио (float32)
  - Стабильная работа фонетизации

## Информация о модели

### Загружаемые файлы:
1. **model.onnx** - основная модель Kokoro TTS (~50-100 MB)
   - URL: `https://huggingface.co/NeuML/kokoro-base-onnx/resolve/main/model.onnx`
   - Альтернативный URL: `https://huggingface.co/NeuML/kokoro-base-onnx/raw/main/model.onnx`

2. **voices.json** - файл с голосами (~10-20 MB)
   - URL: `https://huggingface.co/NeuML/kokoro-base-onnx/resolve/main/voices.json`
   - Альтернативный URL: `https://huggingface.co/NeuML/kokoro-base-onnx/raw/main/voices.json`

3. **tokenizer_vocab.json** - файл словаря токенизатора для фонем (включен в assets проекта)
   - Расположение: `assets/tokenizer_vocab.json`
   - Назначение: Маппинг фонем и символов в числовые токены для токенизатора
   - Включен в проект: Да, файл создан и добавлен в `pubspec.yaml`

### Расположение файлов:
- **model.onnx и voices.json**: Сохраняются в `{AppDocuments}/tts_models/kokoro/` (загружаются автоматически)
- **tokenizer_vocab.json**: Включен в assets проекта (`assets/tokenizer_vocab.json`)
- Проверка наличия: автоматическая при выборе Kokoro TTS

## Что было исправлено и проверено

### ✅ Исправления:
1. **Имена файлов** - изменены с `kokoro-v1.0.onnx` и `voices-v1.0.bin` на `model.onnx` и `voices.json` (соответствует Hugging Face репозиторию)
2. **URL загрузки** - добавлены альтернативные URL на случай недоступности основных
3. **Обработка ошибок** - улучшена с проверкой размера файлов и верификацией сохранения
4. **Очистка временных файлов** - исправлена проблема с множественными слушателями в KokoroTtsEngine
5. **Прогресс загрузки** - исправлен (теперь правильно передается в диалог)
6. **tokenizer_vocab.json** - добавлен файл словаря токенизатора в assets проекта для корректной работы Kokoro TTS
7. **Улучшенная обработка ошибок** - добавлены проверки инициализации Kokoro и Tokenizer с понятными сообщениями об ошибках
8. **Обновление библиотеки** - обновлено до версии 0.2.1-exp для получения исправлений ошибок и улучшений

### ✅ Проверено:
- ✅ Все импорты корректны
- ✅ Нет ошибок линтера
- ✅ Структура файлов соответствует архитектуре
- ✅ Обработка ошибок добавлена на всех уровнях

## Чеклист для тестирования

### 1. Базовое тестирование
- [ ] Приложение компилируется без ошибок
- [ ] Настройки открываются без ошибок
- [ ] Секция TTS Settings отображается корректно

### 2. Тестирование выбора движка
- [ ] По умолчанию выбран "System TTS"
- [ ] При нажатии на "TTS Engine" открывается диалог выбора
- [ ] В диалоге отображаются оба варианта: System TTS и Kokoro TTS
- [ ] Выбор System TTS работает без изменений

### 3. Тестирование загрузки Kokoro модели
- [ ] При выборе Kokoro TTS открывается диалог загрузки
- [ ] Диалог показывает предупреждение "Не выключайте приложение"
- [ ] Прогресс-бар отображается и обновляется
- [ ] Процент загрузки отображается корректно (0% → 50% → 100%)
- [ ] После успешной загрузки диалог закрывается
- [ ] Движок переключается на Kokoro TTS

### 4. Тестирование работы Kokoro TTS
- [ ] После загрузки модели можно использовать Kokoro TTS
- [ ] Синтез речи работает (протестировать на английском тексте)
- [ ] Настройки скорости речи применяются
- [ ] Настройки громкости применяются
- [ ] Остановка воспроизведения работает
- [ ] Пауза работает (если поддерживается)

### 5. Тестирование переключения между движками
- [ ] Переключение с System на Kokoro работает
- [ ] Переключение с Kokoro на System работает
- [ ] Настройки (язык, скорость, громкость) сохраняются при переключении
- [ ] Текущий выбранный движок отображается в настройках

### 6. Тестирование повторной загрузки
- [ ] При повторном выборе Kokoro модель не загружается заново (если уже скачана)
- [ ] Проверка наличия модели работает корректно
- [ ] Если модель удалена вручную, она загружается снова

### 7. Тестирование ошибок
- [ ] При отсутствии интернета показывается понятное сообщение об ошибке
- [ ] При прерывании загрузки можно повторить попытку
- [ ] При ошибке загрузки диалог можно закрыть
- [ ] Приложение не крашится при ошибках

### 8. Тестирование на разных устройствах
- [ ] Android - работает корректно
- [ ] iOS - работает корректно (если поддерживается)
- [ ] Разные версии ОС

## Потенциальные проблемы и решения

### Проблема: Модель не загружается
**Решение:**
- Проверить интернет-соединение
- Проверить доступность Hugging Face
- Проверить логи на наличие ошибок загрузки
- Попробовать альтернативные URL

### Проблема: Kokoro TTS не инициализируется
**Решение:**
- Проверить, что файлы скачаны полностью (model.onnx и voices.json)
- Проверить, что tokenizer_vocab.json присутствует в assets и добавлен в pubspec.yaml
- Проверить права доступа к файлам
- Проверить логи на ошибки инициализации
- Убедиться, что все необходимые файлы загружены и доступны

### Проблема: Ошибка "Failed to load vocabulary from assets/tokenizer_vocab.json"
**Решение:**
- Убедиться, что файл `assets/tokenizer_vocab.json` существует
- Проверить, что файл добавлен в секцию `assets` в `pubspec.yaml`
- Выполнить `flutter clean` и `flutter pub get`
- Пересобрать приложение после добавления файла

### Проблема: Аудио не воспроизводится
**Решение:**
- Проверить настройки громкости устройства
- Проверить, что аудио файл создается корректно
- Проверить логи AudioPlayer

### Проблема: Большой размер модели
**Решение:**
- Модель ~50-100 MB, voices.json ~10-20 MB
- Убедиться, что на устройстве достаточно места
- Предупредить пользователя о размере перед загрузкой

## Дополнительные улучшения (опционально)

1. **Показ размера модели** перед загрузкой
2. **Проверка свободного места** на устройстве перед загрузкой
3. **Возможность удаления модели** из настроек
4. **Кэширование прогресса** загрузки для возможности возобновления
5. **Выбор голоса** для Kokoro TTS (сейчас используется 'af_heart' по умолчанию)

## Полезные ссылки

- Hugging Face репозиторий: https://huggingface.co/NeuML/kokoro-base-onnx
- Документация пакета: https://pub.dev/packages/kokoro_tts_flutter
- Версия пакета: https://pub.dev/packages/kokoro_tts_flutter/versions/0.2.1-exp
- GitHub репозиторий Kokoro: https://github.com/NeonKokoro/kokoro

## Известные проблемы и решения

### Проблема: FormatException при инициализации
**Решение в версии 0.2.1-exp**: Исправлены ошибки парсинга JSON и улучшена обработка ошибок. Если проблема сохраняется, проверьте целостность файла voices.json и перезагрузите модель.

### Проблема: Ошибки с int8 моделями
**Решение в версии 0.2.1-exp**: Исправлена ошибка приведения типов для int8 моделей. Теперь можно использовать оптимизированные модели с флагом `isInt8: true` в KokoroConfig.

### Проблема: Ошибка "Text is too long, must be less than 510 phonemes"
**Описание**: Kokoro TTS имеет ограничение на максимальное количество фонем в одном запросе - 510 фонем. Это ограничение исходит из архитектуры модели и не документировано в официальной документации, но обнаруживается при попытке синтезировать слишком длинный текст.

**Решение**: 
- В `TtsService` добавлена автоматическая обрезка текста до 510 фонем
- Если текст превышает лимит, проигрывается только первая часть
- Пользователю показывается уведомление: "Text is too long. Only the first part is being played."
- Ограничение обнаружено эмпирически из ошибки библиотеки: `Exception: Text is too long, must be less than 510 phonemes`
