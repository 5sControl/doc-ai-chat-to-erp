#!/bin/bash

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π iOS‚Äë–¥–µ–≤–∞–π—Å (–ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–π –ø–æ –∫–∞–±–µ–ª—é).
# –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞–±–µ–ª—å –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ,
# –µ–≥–æ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å —Å –¥–æ–º–∞—à–Ω–µ–≥–æ —ç–∫—Ä–∞–Ω–∞.

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ (—Å–∫—Ä–∏–ø—Ç –ª–µ–∂–∏—Ç –≤ scripts/)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$PROJECT_ROOT"

echo "üì± –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–π iOS‚Äë–¥–µ–≤–∞–π—Å (–æ—Ñ—Ñ–ª–∞–π–Ω-—Å–±–æ—Ä–∫–∞)"
echo "   –ö–∞—Ç–∞–ª–æ–≥ –ø—Ä–æ–µ–∫—Ç–∞: $PROJECT_ROOT"
echo ""

# –†–µ–∂–∏–º: release (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) –∏–ª–∏ debug
MODE="${1:-release}"
if [[ "$MODE" != "release" && "$MODE" != "debug" ]]; then
    echo -e "${RED}–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [release|debug]${NC}"
    echo "  release ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–ª–∏–∑–Ω–æ–π —Å–±–æ—Ä–∫–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è, –±—ã—Å—Ç—Ä–µ–µ –±–µ–∑ –∫–∞–±–µ–ª—è)"
    echo "  debug   ‚Äî –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è —Å–±–æ—Ä–∫–∞"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–µ–≤–∞–π—Å –ø–æ–¥–∫–ª—é—á—ë–Ω
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤..."
if ! flutter devices | grep -q "ios"; then
    echo -e "${RED}‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–π iOS‚Äë–¥–µ–≤–∞–π—Å.${NC}"
    echo "   –ü–æ–¥–∫–ª—é—á–∏—Ç–µ iPhone/iPad –ø–æ –∫–∞–±–µ–ª—é –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ–≤–µ—Ä–∏–µ –∫–æ–º–ø—å—é—Ç–µ—Ä—É –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ."
    exit 1
fi

DEVICE_LINE=$(flutter devices | grep -E "iPhone|iPad" | head -1)
echo -e "${GREEN}‚úÖ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: $DEVICE_LINE${NC}"
echo ""

# –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –ø–æ–¥—ã (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
echo "üì¶ Flutter pub get..."
flutter pub get

echo "üì¶ iOS: pod install..."
(cd ios && pod install)
echo ""

if [[ "$MODE" == "release" ]]; then
    echo "üî® –°–±–æ—Ä–∫–∞ –≤ —Ä–µ–∂–∏–º–µ release –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ..."
    echo "   (–ø–µ—Ä–≤—ã–π —Ä–∞–∑ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç)"
    flutter run --release
else
    echo "üî® –°–±–æ—Ä–∫–∞ –≤ —Ä–µ–∂–∏–º–µ debug –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ..."
    flutter run --debug
fi

echo ""
echo -e "${GREEN}‚úÖ –ì–æ—Ç–æ–≤–æ.${NC}"
echo "   –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ. –ú–æ–∂–µ—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å –∫–∞–±–µ–ª—å."
echo "   –ó–∞–ø—É—Å–∫ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ ‚Äî —Å –¥–æ–º–∞—à–Ω–µ–≥–æ —ç–∫—Ä–∞–Ω–∞ –ø–æ –∏–∫–æ–Ω–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."
